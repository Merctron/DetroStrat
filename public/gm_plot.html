<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
    <style>
           #map {
        height: 400px;
        width: 100%;
        z-index: 2000;
       }

      #mainbar {
        position: relative;
        width: 100%;
        height: 335px;
        background-color: #E8E8E8; 

      }

    </style>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
      
      var map;
      var latLng

      $(document).ready(function(){
        $(".draggable").draggable({ revert: true });

        $(".droppable").droppable({
          drop: function( event, ui ) { 
            placeMarker(latLng);
          }
        });
      });

      function placeMarker(location) {
        var marker = new google.maps.Marker({
          position: location, 
          map: map
        });
      }

      function httpGetAsync(theUrl, callback)
      {
          var xmlHttp = new XMLHttpRequest();
          xmlHttp.onreadystatechange = function() { 
              if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
                  callback(xmlHttp.responseText);
          }
          xmlHttp.open("GET", theUrl, true); // true for asynchronous 
          xmlHttp.send(null);
      }

      function parse_cr(cr_data) {
          var current_set_total = [];
          var current_set;

          for (var i = 0; i < cr_data.data.length; i++) {
            current_set = [];
            /* Push onto the array in the following order: crime, zip, lat, long */
            current_set.push(cr_data.data[i][9]);
            current_set.push(cr_data.data[i][11])
            current_set.push(cr_data.data[i][18][1])
            current_set.push(cr_data.data[i][18][2]);

            current_set_total.push(current_set);

          }

          return current_set_total;
        }

      function initialize() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 10,
          center: new google.maps.LatLng(42.3314, -83.0458),
          mapTypeId: 'terrain'
        });

        google.maps.event.addListener(map, 'click', function(event) {
          placeMarker(event.latLng);
        });

        google.maps.event.addListener(map, 'mousemove', function(event) {
          var proj = map.getProjection();
          latLng = event.latLng;
        });

        // Create a <script> tag and set the USGS URL as the source.
        var script = document.createElement('script');
        // (In this example we use a locally stored copy instead.)
        // script.src = 'http://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_week.geojsonp';
        script.src = 'https://developers.google.com/maps/documentation/javascript/tutorials/js/earthquake_GeoJSONP.js';
        document.getElementsByTagName('head')[0].appendChild(script);

      }

      // Loop through the results array and place a marker for each
      // set of coordinates.
      window.eqfeed_callback = function(results) {
        httpGetAsync('/cr_data', function(data) {
          var cr_data = parse_cr(JSON.parse(data));
          var tower = 'img/tower.png';
          var danger = 'img/danger.png';
          console.log(cr_data);
          for (var i = 0; i < cr_data.length; i++) {
            var latLng = new google.maps.LatLng(cr_data[i][2],cr_data[i][3]);
            var marker = new google.maps.Marker({
              position: latLng,
              map: map,
              icon: danger
            });
          };

          var lat_val = 42.3314;
          var lng_val = -83.2458;
          var spd = 0.005;
          var iter = 0;
          var p_latLng = new google.maps.LatLng(lat_val, lng_val);
          var p_marker = new google.maps.Marker({
              position: p_latLng,
              map: map,
              icon: tower
          });

          var intId = setInterval(function() {
            lat_val += spd;
            lng_val += spd;
            iter++;
            if (iter > 100) {
              iter = 0;
              spd = -spd;
            }
            p_marker.setPosition( new google.maps.LatLng(lat_val, lng_val));
          }, 50);

          // var imageBounds = {
          //     north: 42.3314,
          //     south: 40.712216,
          //     east: -82.0458,
          //     west: -83.0458
          // };

          // historicalOverlay = new google.maps.GroundOverlay(
          //       'https://www.lib.utexas.edu/maps/historical/newark_nj_1922.jpg',
          //       imageBounds);
          // historicalOverlay.setMap(map);
        });
      }
    </script>
  </head>
  <body>
    <div id="map" class="droppable"></div>
    <div id="mainbar">
      <div class="towers">
        <div class="title">
          <span>Towers</span>
        </div>
        <div id="t1">
          <img class = draggable src="img/tower.png">
        </div>
      </div>
      <div class="status">
        <span>Health</span>

        <span>Money</span>
      </div>
    </div>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBnvbLIbhkDRUgb-OnC-KZFYXZILMAYjYk&callback=initialize">
    </script>
  </body>
</html>