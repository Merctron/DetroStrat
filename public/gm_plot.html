<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
    <link href="css/skeleton.css" rel="stylesheet">
    <link href="css/normalize.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Orbitron:400,900" rel="stylesheet">
    <style>
      * {
        font-family: 'Orbitron', sans-serif;
        font-size: 20px;
      }
      body, html {
        background-color: #171717;
        height:100%;
        overflow: hidden;
        overflow-y: hidden;
      }
      #info {
        float:left;
        color: white;
        width: 275px;
        height: 100%;
        text-align: center;
        display: inline;
        overflow-y: scroll;
      }
      #map {
        height: 100vh;
      }
    </style>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
      
      var map;
      var latLng

      $(document).ready(function(){
        $(".draggable").draggable({ revert: true });

        $(".droppable").droppable({
          drop: function( event, ui ) { 
            placeMarker(latLng);
          }
        });
      });

      function placeMarker(location) {
        var marker = new google.maps.Marker({
          position: location, 
          map: map
        });
      }

      var map;
      var p_sprites = [];
      var s_sprites = [];
      var b_sprites = [];
      var e_sprites = [];
      var d_sprites = [];

      var speeds = [0.0001, 0.0002, 0.0003, 0.0004, -0.0001, -0.0002, -0.0003, -0.0004];
      var prc_keys = ["data_01", "data_02", "data_03", "data_04", "data_05", "data_06", "data_07", "data_08", "data_09", "data_10", "data_11", "data_12"];

      var tower = 'img/tower.png';
      var tower_s = 'img/tower_s.png';
      var danger = 'img/danger.png';
      var bomb = 'img/bomb.png'
      var enemy = 'img/enemy.png';
      var enemy_gr = 'img/enemy_green.png';
      var enemy_rd = 'img/enemy_red.png';

      var max_enemies = 20;
      var max_bombs = 20;
      var max_lat = 0;
      var min_lat = 0;
      var max_lng = 0;
      var min_lng = 0;

      var score = 0;
      var health = 100;
      var tower_type = 1;
      var max_def = 7;
      var gmId = 0;


      function httpGetAsync(theUrl, callback)
      {
          var xmlHttp = new XMLHttpRequest();
          xmlHttp.onreadystatechange = function() { 
              if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
                  callback(xmlHttp.responseText);
          }
          xmlHttp.open("GET", theUrl, true); // true for asynchronous 
          xmlHttp.send(null);
      }

      function getRandomNumber(min, max) {
        var rand = min + Math.random()*(max+1-min);
        rand = Math.floor(rand);
        return rand;
      };

      function getRandomSpd() {
        var rand_ind = getRandomNumber(0, 7);
        return speeds[rand_ind];
      }

      function parse_cr(cr_data, prc) {
          var current_set_total = [];
          var current_set;

          for (var i = 0; i < cr_data[prc].dp.length; i++) {
            current_set = [];
            /* Push onto the array in the following order: crime, zip, lat, long */
            //current_set.push(cr_data.data[i][9]);
            //current_set.push(cr_data.data[i][11])
            current_set.push(cr_data[prc].dp[i][18][1])
            current_set.push(cr_data[prc].dp[i][18][2]);

            current_set_total.push(current_set);

          }

          return current_set_total;
      }

      function placeTowerMarker(latlng, lat, lng) {
        if (p_sprites.length < max_def) {
          var marker = new google.maps.Marker({
              position: latlng,
              map: map,
              icon: tower
          });
          p_sprites.push({
              s_marker: marker,
              s_lat: lat,
              s_lng: lng
          });
        }
      }

      function placeSafeTowerMarker(latlng, lat, lng) {
          var marker = new google.maps.Marker({
              position: latlng,
              map: map,
              icon: tower_s
          });
          s_sprites.push({
              s_marker: marker,
              s_lat: lat,
              s_lng: lng
          });

          $.post( "/sfsubmit", {
              lat: lat,
              lng: lng
            }, function( data ) {
              console.log(data);
          }, "json");

          // $.ajax({
          //   type: "POST",
          //   url: '/sfsubmit',
          //   data: {
          //     lat: lat,
          //     lng: lng
          //   },
          //   success: success,
          //   dataType: dataType
          // });
      }

      function spawnEnemy(lat, lng) {
        var latLng = new google.maps.LatLng(lat, lng);
        var marker = new google.maps.Marker({
              position: latLng,
              map: map,
              icon: enemy
        });
        e_sprites.push({
          s_marker: marker,
          s_lat: lat,
          s_lng: lng,
          x_spd: getRandomSpd(),
          y_spd: getRandomSpd(),
          abs_dist: 0,
          gr_set: false,
          rd_set: false
        });
      }

      function spawnBomb(lat, lng) {
        var latLng = new google.maps.LatLng(lat, lng);
        var marker = new google.maps.Marker({
              position: latLng,
              map: map,
              icon: bomb
        });
        b_sprites.push({
          s_marker: marker,
          s_lat: lat,
          s_lng: lng,
          x_spd: getRandomSpd(),
          y_spd: getRandomSpd(),
          abs_dist: 0
        });
      }

      function startGame() {

          clearInterval(gmId);
          score = 0;
          health = 100;
          $("#health").text("Health: " + health);
          $("#score").text("Score: " + score);

          for (var i = 0; i < p_sprites.length; i++) {
            p_sprites[i].s_marker.setMap(null);
          }
          p_sprites = [];

          for (var i = 0; i < b_sprites.length; i++) {
            b_sprites[i].s_marker.setMap(null);
          }
          b_sprites = [];

          for (var i = 0; i < s_sprites.length; i++) {
            s_sprites[i].s_marker.setMap(null);
          }
          s_sprites = [];

          for (var i = 0; i < d_sprites.length; i++) {
            d_sprites[i].s_marker.setMap(null);
          }
          d_sprites = [];

          for (var i = 0; i < e_sprites.length; i++) {
            e_sprites[i].s_marker.setMap(null);
          }
          e_sprites = [];

          httpGetAsync('/cr_data', function(data) {
            
            var pr_ind = parseInt($("#pr_select").val()) - 1;
            var cr_data = parse_cr(JSON.parse(data),  prc_keys[pr_ind]);
            map.setCenter(new google.maps.LatLng(JSON.parse(data)[prc_keys[pr_ind]].c_lat, JSON.parse(data)[prc_keys[pr_ind]].c_lng));
            console.log(cr_data);
            for (var i = 0; i < cr_data.length; i++) {
              var latLng = new google.maps.LatLng(cr_data[i][0],cr_data[i][1]);
              var marker = new google.maps.Marker({
                position: latLng,
                map: map,
                icon: danger
              });

              d_sprites.push({
                s_marker: marker,
                s_lat: parseFloat(cr_data[i][0]),
                s_lng: parseFloat(cr_data[i][1])
              });
            };

          });

          var spd = 0.005;
          var iter = 0;
          iter2 = 100;
          var spawn = true;

          gmId = setInterval(function() {
            if (health <= 0) {
              clearInterval(intId);
            }

            for (var i = 0; i < e_sprites.length; i++) {
              if (e_sprites[i].s_lat > max_lat || e_sprites[i].s_lat < min_lat) {
                e_sprites[i].x_spd = -e_sprites[i].x_spd;
              }
              if (e_sprites[i].s_lng > max_lng || e_sprites[i].s_lng < min_lng) {
                e_sprites[i].y_spd = -e_sprites[i].y_spd;
              }
              e_sprites[i].s_lat += e_sprites[i].x_spd;
              e_sprites[i].s_lng += e_sprites[i].y_spd;
              e_sprites[i].abs_dist++;
              
              if (e_sprites[i].abs_dist > 200 && !e_sprites[i].gr_set) {
                e_sprites[i].s_marker.setIcon(enemy_gr);
                e_sprites[i].gr_set = true;
              }
              if (e_sprites[i].abs_dist > 600 && !e_sprites[i].rd_set) {
                e_sprites[i].s_marker.setIcon(enemy_rd);
                e_sprites[i].rd_set = true;
                health--;
                $("#health").text("Health: " + health);
              }
              e_sprites[i].s_marker.setPosition(new google.maps.LatLng(e_sprites[i].s_lat, e_sprites[i].s_lng));
              if (e_sprites[i].abs_dist > 900) {
                e_sprites[i].s_marker.setMap(null);
                e_sprites.splice(i, 1);
              }
            }

            for (var i = 0; i < b_sprites.length; i++) {
              b_sprites[i].s_lat += b_sprites[i].x_spd;
              b_sprites[i].s_lng += b_sprites[i].y_spd;
              b_sprites[i].abs_dist++;
              b_sprites[i].s_marker.setPosition(new google.maps.LatLng(b_sprites[i].s_lat, b_sprites[i].s_lng));
              if (b_sprites[i].abs_dist > 100) {
                b_sprites[i].s_marker.setMap(null);
                b_sprites.splice(i, 1);
              }
            }

            for (var i = 0; i < b_sprites.length; i++) {
              for (var j = 0; j < e_sprites.length; j++) {
                  if (detectColl(b_sprites[i], e_sprites[j])) {
                    b_sprites[i].s_marker.setMap(null);
                    b_sprites.splice(i, 1);
                    e_sprites[j].s_marker.setMap(null);
                    e_sprites.splice(j, 1);
                    score++;
                    $("#score").text("Score: " + score);
                  }
              }
            }

            //lat_val += spd;
            //lng_val += spd;
            iter++;
            if (iter % 10 == 0 && e_sprites.length < max_enemies) {
              for (var i = 0; i < 5; i++) {
                var d_ind = getRandomNumber(0, d_sprites.length - 1);
                spawnEnemy(d_sprites[d_ind].s_lat, d_sprites[d_ind].s_lng);
              }
            }

            iter2++;
            if (iter2 > 40 && b_sprites.length < max_bombs) {
              iter2 = 0;
              for (var i = 0; i < p_sprites.length; i++) {
                for (var j = 0; j < 2; j++) {
                  spawnBomb(p_sprites[i].s_lat, p_sprites[i].s_lng);
                }
              }
            }
            //p_marker.setPosition( new google.maps.LatLng(lat_val, lng_val));
          }, 50);
      }

      function endGame() {

      }

      function detectColl(sprite_1, sprite_2) {
        var r_x = 0.005;
        var r_y = 0.005;
        if ((sprite_2.s_lat > sprite_1.s_lat - r_x && sprite_2.s_lat < sprite_1.s_lat + r_x*2) && 
          (sprite_2.s_lng > sprite_1.s_lng - r_y && sprite_2.s_lng < sprite_1.s_lng + r_y*2)) {
          return true;
        }
        return false;
      }

      function initialize() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 14,
          center: new google.maps.LatLng(42.40723, -83.07037),
          mapTypeId: 'terrain'
        });

        map.setOptions({ minZoom: 11, maxZoom: 17 });

        google.maps.event.addListener(map, 'bounds_changed', function() {
          max_lat = map.getBounds().getNorthEast().lat();
          max_lng = map.getBounds().getNorthEast().lng();
          min_lat = map.getBounds().getSouthWest().lat();
          min_lng = map.getBounds().getSouthWest().lng();
        });

        // Create a <script> tag and set the USGS URL as the source.
        var script = document.createElement('script');
        // (In this example we use a locally stored copy instead.)
        // script.src = 'http://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_week.geojsonp';
        script.src = 'https://developers.google.com/maps/documentation/javascript/tutorials/js/earthquake_GeoJSONP.js';
        document.getElementsByTagName('head')[0].appendChild(script);

        var myListener = google.maps.event.addListener(map, 'click', function(event) {
            if (tower_type == 1) {
              placeSafeTowerMarker(event.latLng, event.latLng.lat(), event.latLng.lng());
            }
            else {
              placeTowerMarker(event.latLng, event.latLng.lat(), event.latLng.lng());  
            }
            
        });

        $("#t1button").click(function() {
          tower_type = 1;
        });

        $("#t2button").click(function() {
          tower_type = 2;
        });

        $("#playbutton").click(function() {
          startGame();
        });

      }

      // Loop through the results array and place a marker for each
      // set of coordinates.
      window.eqfeed_callback = function(results) {
        startGame();
      }
    </script>
  </head>
  <body>
    <div id="info">
      

      <h2 class="gtitle" style="margin-top:10px;">Detrostrat</h2>


      <h2 id="score" class="dp" style="font-size: 30px; margin-top:20px;">Score: 0</h2>
      <h2 id="health" class="dp" style="font-size: 30px;">Health: 100</h2>


      <p><button id="playbutton" href="javascript" style="margin-top:20px;">New Game</button></p>
      <p><button id="helpbutton" href="javascript">Help / About</button></p>
      <a href="/sf_plot.html" target="_blank"><button id="mapbutton">Safety Map</button></a>
      <select id="pr_select" style="background-color:#000; margin-top:15px;">
        <option value="1">Precint 1</option>
        <option value="2">Precint 2</option>
        <option value="3">Precint 3</option>
        <option value="4">Precint 4</option>
        <option value="5">Precint 5</option>
        <option value="6">Precint 6</option>
        <option value="7">Precint 7</option>
        <option value="8">Precint 8</option>
        <option value="9">Precint 9</option>
        <option value="10">Precint 10</option>
        <option value="11">Precint 11</option>
        <option value="12">Precint 12</option>
      </select>

      <p><button id="t1button" href="javascript" style="margin-top:20px;">Safe Tower</button></p>
      <p><button id="t2button" href="javascript">Defense Tower</button></p>


    </div>
    <div id="map"></div>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBnvbLIbhkDRUgb-OnC-KZFYXZILMAYjYk&callback=initialize">
    </script>
  </body>
</html>