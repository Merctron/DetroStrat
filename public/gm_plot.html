<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
    <style>
           #map {
        height: 400px;
        width: 100%;
       }
    </style>
    <script>


      var map;
      var p_sprites;
      var b_sprites;
      var e_sprites;
      var d_sprites;

      var speeds = [0.001, 0.002, 0.003, 0.004, -0.001, -0.002, -0.003, -0.004];

      var tower = 'img/tower.png';
      var danger = 'img/danger.png';
      var bomb = 'img/bomb.png'

      function httpGetAsync(theUrl, callback)
      {
          var xmlHttp = new XMLHttpRequest();
          xmlHttp.onreadystatechange = function() { 
              if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
                  callback(xmlHttp.responseText);
          }
          xmlHttp.open("GET", theUrl, true); // true for asynchronous 
          xmlHttp.send(null);
      }

      function getRandomNumber(min, max) {
        var rand = min + Math.random()*(max+1-min);
        rand = Math.floor(rand);
        return rand;
      };

      function getRandomSpd() {
        var rand_ind = getRandomNumber(0, 7);
        return speeds[rand_ind];
      }

      function parse_cr(cr_data) {
          var current_set_total = [];
          var current_set;

          for (var i = 0; i < cr_data.data.length; i++) {
            current_set = [];
            /* Push onto the array in the following order: crime, zip, lat, long */
            current_set.push(cr_data.data[i][9]);
            current_set.push(cr_data.data[i][11])
            current_set.push(cr_data.data[i][18][1])
            current_set.push(cr_data.data[i][18][2]);

            current_set_total.push(current_set);

          }

          return current_set_total;
      }

      function placeTowerMarker(latlng, lat, lng) {
          var marker = new google.maps.Marker({
              position: latlng,
              map: map,
              icon: tower
          });
          p_sprites.push({
              s_marker: marker,
              s_lat: lat,
              s_lng: lng
          });
      }

      function spawnEnemy(lat, lng) {
        var latLng = new google.maps.LatLng(lat, lng);
        var marker = new google.maps.Marker({
              position: latLng,
              map: map,
              icon: danger
        });
        e_sprites.push({
          s_marker: marker,
          s_lat: lat,
          s_lng: lng,
          x_spd: getRandomSpd(),
          y_spd: getRandomSpd()
        });
      }

      function spawnBomb(lat, lng) {
        var latLng = new google.maps.LatLng(lat, lng);
        var marker = new google.maps.Marker({
              position: latLng,
              map: map,
              icon: bomb
        });
        b_sprites.push({
          s_marker: marker,
          s_lat: lat,
          s_lng: lng,
          x_spd: getRandomSpd(),
          y_spd: getRandomSpd()
        });
      }

      function initialize() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 10,
          center: new google.maps.LatLng(42.3314, -83.0458),
          mapTypeId: 'terrain'
        });

        p_sprites = [];
        b_sprites = [];
        e_sprites = [];
        d_sprites = [];

        // Create a <script> tag and set the USGS URL as the source.
        var script = document.createElement('script');
        // (In this example we use a locally stored copy instead.)
        // script.src = 'http://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_week.geojsonp';
        script.src = 'https://developers.google.com/maps/documentation/javascript/tutorials/js/earthquake_GeoJSONP.js';
        document.getElementsByTagName('head')[0].appendChild(script);

        var myListener = google.maps.event.addListener(map, 'click', function(event) {
            console.log(event);
            placeTowerMarker(event.latLng, event.latLng.lat(), event.latLng.lng());
        });

      }

      // Loop through the results array and place a marker for each
      // set of coordinates.
      window.eqfeed_callback = function(results) {
        httpGetAsync('/cr_data', function(data) {
          var cr_data = parse_cr(JSON.parse(data));
          
          console.log(cr_data);
          for (var i = 0; i < cr_data.length; i++) {
            var latLng = new google.maps.LatLng(cr_data[i][2],cr_data[i][3]);
            var marker = new google.maps.Marker({
              position: latLng,
              map: map,
              icon: danger
            });

            d_sprites.push({
              s_marker: marker,
              s_lat: parseFloat(cr_data[i][2]),
              s_lng: parseFloat(cr_data[i][3])
            });
          };

          var spd = 0.005;
          var iter = 0;
          iter2 = 100;
          var spawn = true;

          var intId = setInterval(function() {
            for (var i = 0; i < e_sprites.length; i++) {
              e_sprites[i].s_lat += e_sprites[i].x_spd;
              e_sprites[i].s_lng += e_sprites[i].y_spd;
              e_sprites[i].s_marker.setPosition(new google.maps.LatLng(e_sprites[i].s_lat, e_sprites[i].s_lng));
            }

            for (var i = 0; i < b_sprites.length; i++) {
              b_sprites[i].s_lat += b_sprites[i].x_spd;
              b_sprites[i].s_lng += b_sprites[i].y_spd;
              b_sprites[i].s_marker.setPosition(new google.maps.LatLng(b_sprites[i].s_lat, b_sprites[i].s_lng));
            }
            //lat_val += spd;
            //lng_val += spd;
            iter++;
            if (iter > 10 && e_sprites.length < 100) {
              spd = -spd;
              spawn = false;
              for (var i = 0; i < d_sprites.length; i++) {
                for (var j = 0; j < 5; j++) {
                  spawnEnemy(d_sprites[i].s_lat, d_sprites[i].s_lng);
                }
              }
            }

            iter2++;
            if (iter2 > 40) {
              iter2 = 0;
              for (var i = 0; i < p_sprites.length; i++) {
                for (var j = 0; j < 5; j++) {
                  spawnBomb(p_sprites[i].s_lat, p_sprites[i].s_lng);
                }
              }
            }
            //p_marker.setPosition( new google.maps.LatLng(lat_val, lng_val));
          }, 50);

          // var imageBounds = {
          //     north: 42.3314,
          //     south: 40.712216,
          //     east: -82.0458,
          //     west: -83.0458
          // };

          // historicalOverlay = new google.maps.GroundOverlay(
          //       'https://www.lib.utexas.edu/maps/historical/newark_nj_1922.jpg',
          //       imageBounds);
          // historicalOverlay.setMap(map);
        });
      }
    </script>
  </head>
  <body>
    <div id="map"></div>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBnvbLIbhkDRUgb-OnC-KZFYXZILMAYjYk&callback=initialize">
    </script>
  </body>
</html>